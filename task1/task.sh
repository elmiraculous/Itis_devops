#!/bin/bash

# Проверка наличия ключа "-d" для указания пути к корневой директории создания директорий
while getopts ":d:" opt; do
  case $opt in
    d)
      root_dir="$OPTARG"
      ;;
    \?)
      echo "Неверный ключ: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

# Если ключ "-d" не указан, показываем диалог для определения пути
if [ -z "$root_dir" ]; then
  read -p "Введите путь к корневой директории создания директорий: " root_dir
fi

# Проверяем существование указанной директории
if [ ! -d "$root_dir" ]; then
  echo "Указанная директория не существует: $root_dir" >&2
  exit 1
fi

# Лог-файл для записи
log_file="directory_creation.log"

# Получаем список всех пользователей в системе
users=$(getent passwd | cut -d: -f1)

# Проходим по каждому пользователю
for user in $users; do
  # Создаем директорию с именем пользователя в корневой директории
  user_dir="$root_dir/$user"
  mkdir -p "$user_dir"
  
  # Устанавливаем права 755 для директории
  chmod 755 "$user_dir"
  
  # Устанавливаем владельца директории на текущего пользователя
  chown "$user:$user" "$user_dir"
  
  # Записываем информацию о создании директории в лог
  echo "$(date '+%Y-%m-%d %H:%M:%S') - Создана директория для пользователя $user: $user_dir" | tee -a "$log_file"
done

echo "Все директории созданы и права установлены."
echo "Лог записан в файл: $log_file"
